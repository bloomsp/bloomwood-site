---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BackToTop from '../components/BackToTop';

export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  jsonLd?: Record<string, any> | Array<Record<string, any>>;
}

const { title, description, ogImage, jsonLd } = Astro.props;

const pathname = Astro.url.pathname;
const isMedia = pathname === '/media/' || pathname.startsWith('/media/');
const isSolutions = pathname === '/solutions/' || pathname.startsWith('/solutions/');

// Default JSON-LD by section (can be overridden per-page by passing jsonLd)
import { organizationSchema, websiteSchema, localBusinessSchema, serviceSchema, breadcrumbSchema } from '../lib/schema';
const canonical = new URL(Astro.url.pathname, Astro.site ?? Astro.url).toString();

function titleCaseSegment(seg: string) {
  return seg
    .replace(/[-_]+/g, ' ')
    .replace(/\b\w/g, (m) => m.toUpperCase());
}

function breadcrumbsForPath(pathname: string) {
  const parts = pathname.replace(/^\/+|\/+$/g, '').split('/').filter(Boolean);
  const crumbs: Array<{ name: string; url: string }> = [{ name: 'Home', url: new URL('/', Astro.site ?? Astro.url).toString() }];

  let acc = '';
  for (const p of parts) {
    acc += `/${p}`;
    crumbs.push({ name: titleCaseSegment(p), url: new URL(`${acc}/`, Astro.site ?? Astro.url).toString() });
  }

  return crumbs;
}

const defaultJsonLd = (() => {
  // Always include the general WebSite + Organization + breadcrumbs on every page.
  const base = [websiteSchema(), organizationSchema(), breadcrumbSchema(breadcrumbsForPath(pathname))];

  if (isSolutions) {
    // Strong local SEO signal for the Solutions section.
    base.push(
      localBusinessSchema({
        name: 'Bloomwood Solutions',
        url: new URL('/solutions/', Astro.site ?? Astro.url).toString(),
      })
    );

    // For key pages, add Service schema to describe the offering.
    if (pathname === '/solutions/' || pathname === '/solutions/bookings/' || pathname === '/solutions/bookings/services/') {
      base.push(
        serviceSchema({
          name: 'IT Support & Tech Help (Onsite and Remote)',
          url: canonical,
          serviceType: 'IT support',
          description:
            description ??
            'Friendly IT support and general tech help for homes and small business in the Cairns region.',
        })
      );
    }
  }

  // Media can stay as Organization/WebSite for now (until you want PublishingService, etc.)
  return base;
})();

const umbrellaNav = [
  { href: '/solutions/', label: 'Solutions' },
  { href: '/media/', label: 'Media' },
];

const solutionsNav = [
  { href: '/solutions/', label: 'Solutions Home' },
  {
    label: 'Bookings',
    items: [
      { href: '/solutions/bookings/', label: 'Make a booking' },
      { href: '/solutions/bookings/service-area/', label: 'Service Area' },
      { href: '/solutions/bookings/services/', label: 'Other Services' },
      { href: '/solutions/bookings/faq/', label: 'FAQ' },
    ],
  },
  { href: '/solutions/bookings/pre-paid-service-packs/', label: 'Service Packs' },
  {
    label: 'About',
    items: [
      { href: '/solutions/about/', label: 'About' },
      { href: '/solutions/about/faq/', label: 'FAQ' },
      { href: '/solutions/about/privacy-policy/', label: 'Privacy Policy' },
      { href: '/solutions/about/cookie-policy/', label: 'Cookie Policy' },
      { href: '/solutions/about/website-terms-of-use/', label: 'Website Terms of Use' },
      { href: '/solutions/about/terms-conditions/', label: 'Terms & Conditions (Supply of Services & Goods)' },
    ],
  },
  { href: '/solutions/bloomwood-solutions-contact-us/', label: 'Contact Us' },
];

const mediaNav = [
  { href: '/', label: 'Bloomwood Home' },
  { href: '/media/', label: 'Media Home' },
  {
    label: 'Services',
    items: [
      { href: '/media/services/editing/', label: 'Editing' },
      { href: '/media/services/publishing/', label: 'Publishing' },
      { href: '/media/services/technical-writing/', label: 'Technical Writing' },
      { href: '/media/services/video-editing/', label: 'Video Editing' },
      { href: '/media/services/website-design/', label: 'Website Design' },
      { href: '/media/resources/', label: 'Resources' },
    ],
  },
  { href: '/media/testimonials/', label: 'Testimonials' },
  { href: '/media/blog/', label: 'Blog' },
  {
    label: "Steven's Quantum Qitchen",
    items: [
      { href: '/media/sqq/episode-1/', label: 'SQQ Episode 1' },
      { href: '/media/sqq/episode-2/', label: 'SQQ Episode 2' },
      { href: '/media/sqq/episode-3/', label: 'SQQ Episode 3' },
      { href: '/media/sqq/episode-4/', label: 'SQQ Episode 4' },
      { href: '/media/sqq/episode-5/', label: 'SQQ Episode 5' },
      { href: '/media/sqq/episode-6/', label: 'SQQ Episode 6' },
      { href: '/media/sqq/recipes/', label: 'Recipes' },
    ],
  },
  {
    label: 'About',
    items: [
      { href: '/media/about/faq/', label: 'FAQ' },
      { href: '/media/about/contact-us/', label: 'Contact Us' },
      { href: '/media/about/privacy-policy/', label: 'Privacy Policy' },
      { href: '/media/about/cookie-policy/', label: 'Cookie Policy' },
      { href: '/media/about/website-terms-and-conditions-of-use/', label: 'Website Terms & Conditions of Use' },
      { href: '/media/about/terms-conditions/', label: 'Terms & Conditions - Supply of Services & Goods' },
    ],
  },
  { href: '/media/shop/', label: 'Shop' },
];

const headerProps = isMedia
  ? {
      homeHref: '/media/',
      brandLabel: 'Bloomwood Media',
      logoSrc: '/logo-media.svg',
      logoAlt: 'Bloomwood Media',
      nav: mediaNav,
    }
  : isSolutions
    ? {
        homeHref: '/solutions/',
        brandLabel: 'Bloomwood Solutions',
        logoSrc: '/logo.svg',
        logoAlt: 'Bloomwood Solutions',
        nav: solutionsNav,
      }
    : {
        homeHref: '/',
        brandLabel: 'Bloomwood',
        logoSrc: '/logo.svg',
        logoAlt: 'Bloomwood',
        nav: umbrellaNav,
      };

const siteName = isMedia ? 'Bloomwood Media' : isSolutions ? 'Bloomwood Solutions' : 'Bloomwood';
---

<BaseLayout
  title={title}
  siteName={siteName}
  description={description}
  ogImage={ogImage}
  jsonLd={jsonLd ?? defaultJsonLd}
>
  <Fragment slot="head">
    <slot name="head" />
  </Fragment>

  <Header {...headerProps} />
  <main class="mx-auto max-w-5xl px-4 py-10">
    <article class="prose prose-slate max-w-none">
      <slot />
    </article>
  </main>
  <Footer />

  <BackToTop client:idle />
</BaseLayout>
