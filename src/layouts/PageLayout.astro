---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BackToTop from '../components/BackToTop';

export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  jsonLd?: Record<string, any> | Array<Record<string, any>>;
}

const { title, description, ogImage, jsonLd } = Astro.props;

const pathname = Astro.url.pathname;
const isMedia = pathname === '/media/' || pathname.startsWith('/media/');
const isSolutions = pathname === '/solutions/' || pathname.startsWith('/solutions/');

// Default JSON-LD by section (can be overridden per-page by passing jsonLd)
import { organizationSchema, websiteSchema, localBusinessSchema, serviceSchema } from '../lib/schema';
const canonical = new URL(Astro.url.pathname, Astro.site ?? Astro.url).toString();

const defaultJsonLd = (() => {
  // Always include the general WebSite + Organization on every page.
  const base = [websiteSchema(), organizationSchema()];

  if (isSolutions) {
    // Strong local SEO signal for the Solutions section.
    base.push(
      localBusinessSchema({
        name: 'Bloomwood Solutions',
        url: new URL('/solutions/', Astro.site ?? Astro.url).toString(),
      })
    );

    // For key pages, add Service schema to describe the offering.
    if (pathname === '/solutions/' || pathname === '/solutions/bookings/' || pathname === '/solutions/bookings/services/') {
      base.push(
        serviceSchema({
          name: 'IT Support & Tech Help (Onsite and Remote)',
          url: canonical,
          serviceType: 'IT support',
          description:
            description ??
            'Friendly IT support and general tech help for homes and small business in the Cairns region.',
        })
      );
    }
  }

  // Media can stay as Organization/WebSite for now (until you want PublishingService, etc.)
  return base;
})();

const umbrellaNav = [
  { href: '/solutions/', label: 'Solutions' },
  { href: '/media/', label: 'Media' },
];

const solutionsNav = [
  { href: '/solutions/', label: 'Solutions Home' },
  {
    label: 'Bookings',
    items: [
      { href: '/solutions/bookings/', label: 'Make a booking' },
      { href: '/solutions/bookings/service-area/', label: 'Service Area' },
      { href: '/solutions/bookings/services/', label: 'Other Services' },
      { href: '/solutions/bookings/faq/', label: 'FAQ' },
    ],
  },
  { href: '/solutions/bookings/pre-paid-service-packs/', label: 'Service Packs' },
  {
    label: 'About',
    items: [
      { href: '/solutions/about/', label: 'About' },
      { href: '/solutions/about/faq/', label: 'FAQ' },
      { href: '/solutions/about/privacy-policy/', label: 'Privacy Policy' },
      { href: '/solutions/about/cookie-policy/', label: 'Cookie Policy' },
      { href: '/solutions/about/website-terms-of-use/', label: 'Website Terms of Use' },
      { href: '/solutions/about/terms-conditions/', label: 'Terms & Conditions (Supply of Services & Goods)' },
    ],
  },
  { href: '/solutions/bloomwood-solutions-contact-us/', label: 'Contact Us' },
];

const mediaNav = [
  { href: '/', label: 'Bloomwood Home' },
  { href: '/media/', label: 'Media Home' },
  // Add when ready:
  // { href: '/media/services/', label: 'Services' },
  // { href: '/media/portfolio/', label: 'Portfolio' },
  // { href: '/media/contact/', label: 'Contact' },
];

const headerProps = isMedia
  ? {
      homeHref: '/media/',
      brandLabel: 'Bloomwood Media',
      logoSrc: '/logo-media.svg',
      logoAlt: 'Bloomwood Media',
      nav: mediaNav,
    }
  : isSolutions
    ? {
        homeHref: '/solutions/',
        brandLabel: 'Bloomwood Solutions',
        logoSrc: '/logo.svg',
        logoAlt: 'Bloomwood Solutions',
        nav: solutionsNav,
      }
    : {
        homeHref: '/',
        brandLabel: 'Bloomwood',
        logoSrc: '/logo.svg',
        logoAlt: 'Bloomwood',
        nav: umbrellaNav,
      };

const siteName = isMedia ? 'Bloomwood Media' : isSolutions ? 'Bloomwood Solutions' : 'Bloomwood';
---

<BaseLayout
  title={title}
  siteName={siteName}
  description={description}
  ogImage={ogImage}
  jsonLd={jsonLd ?? defaultJsonLd}
>
  <Fragment slot="head">
    <slot name="head" />
  </Fragment>

  <Header {...headerProps} />
  <main class="mx-auto max-w-5xl px-4 py-10">
    <article class="prose prose-slate max-w-none">
      <slot />
    </article>
  </main>
  <Footer />

  <BackToTop client:idle />
</BaseLayout>
