---
import { getCollection } from 'astro:content';
import PageLayout from '../layouts/PageLayout.astro';

export const prerender = true;

export async function getStaticPaths() {
  // Exclude content slugs that have dedicated Astro routes.
  // Otherwise, `[...slug]` will try to prerender them too, causing route conflicts.
  const EXCLUDE_SLUGS = new Set([
    'solutions/bookings', // handled by src/pages/solutions/bookings/index.astro
    'solutions/bookings/pre-paid-service-packs', // handled by src/pages/solutions/bookings/pre-paid-service-packs.astro
  ]);

  const pages = await getCollection('pages', ({ data, slug }) => !data.draft && !EXCLUDE_SLUGS.has(slug));
  // For rest params, Astro expects a single string (e.g. "a/b/c").
  return pages.map((p) => ({ params: { slug: p.slug } }));
}

const EXCLUDE_SLUGS = new Set([
  'solutions/bookings', // handled by src/pages/solutions/bookings/index.astro
  'solutions/bookings/pre-paid-service-packs', // handled by src/pages/solutions/bookings/pre-paid-service-packs.astro
]);

const pages = await getCollection('pages', ({ data, slug }) => !data.draft && !EXCLUDE_SLUGS.has(slug));

const slug = Astro.params.slug ?? '';
const key = Array.isArray(slug) ? slug.join('/') : slug;

const entry = pages.find((p) => p.slug === key);
if (!entry) throw new Error(`Page not found: ${key}`);

const { Content } = await entry.render();
const data = entry.data;
---

<PageLayout title={data.title} description={data.description} ogImage={data.ogImage}>
  <Content />
</PageLayout>
